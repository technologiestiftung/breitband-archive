"use strict";function NDTjs(t,e,s,r,n,o){this.server=t,this.serverPort=e||3001,this.serverPath=r||"/ndt_protocol",this.serverProtocol=s||"ws",this.updateInterval=o/1e3||!1,this.results={c2sRate:void 0,s2cRate:void 0},this.SEND_BUFFER_SIZE=1048576,void 0===n?this.callbacks={onstart:function(){return!1},onstatechange:function(){return!1},onprogress:function(){return!1},onfinish:function(){return!1},onerror:function(){return!1}}:this.callbacks=n,this.COMM_FAILURE=0,this.SRV_QUEUE=1,this.MSG_LOGIN=2,this.TEST_PREPARE=3,this.TEST_START=4,this.TEST_MSG=5,this.TEST_FINALIZE=6,this.MSG_ERROR=7,this.MSG_RESULTS=8,this.MSG_LOGOUT=9,this.MSG_WAITING=10,this.MSG_EXTENDED_LOGIN=11,this.NDT_MESSAGES=[],this.NDT_MESSAGES[this.COMM_FAILURE]="COMM_FAILURE",this.NDT_MESSAGES[this.SRV_QUEUE]="SRV_QUEUE",this.NDT_MESSAGES[this.MSG_LOGIN]="MSG_LOGIN",this.NDT_MESSAGES[this.TEST_PREPARE]="TEST_PREPARE",this.NDT_MESSAGES[this.TEST_START]="TEST_START",this.NDT_MESSAGES[this.TEST_MSG]="TEST_MSG",this.NDT_MESSAGES[this.TEST_FINALIZE]="TEST_FINALIZE",this.NDT_MESSAGES[this.MSG_ERROR]="MSG_ERROR",this.NDT_MESSAGES[this.MSG_RESULTS]="MSG_RESULTS",this.NDT_MESSAGES[this.MSG_LOGOUT]="MSG_LOGOUT",this.NDT_MESSAGES[this.MSG_WAITING]="MSG_WAITING",this.NDT_MESSAGES[this.MSG_EXTENDED_LOGIN]="MSG_EXTENDED_LOGIN"}function NDTWrapper(t,e){var s=this;this.scriptPath=e,this.use_web_worker=!1;var r="undefined"!=typeof InstallTrigger,n=!!window.Worker;n&&(this.use_web_worker=!0),r&&(this.use_web_worker=!1),this._hostname=t,this._port="https:"==location.protocol?3010:3001,this._protocol="https:"==location.protocol?"wss":"ws",this._path="/ndt_protocol",this._update_interval=1e3,this.reset()}function NDTPlugin(t){this.path=t,this.server="ndt.iupui.mlab1.ham01.measurement-lab.org",this.websocket_client=!1}NDTjs.prototype.logger=function(t,e){e=e||!1,e===!0&&console.log(t)},NDTjs.prototype.checkBrowserSupport=function(){if(void 0===self.WebSocket&&void 0===self.MozWebSocket)throw this.UnsupportedBrowser("No Websockets");return!0},NDTjs.prototype.makeLoginMessage=function(t){var e,s='XXX { "msg": "v3.5.5", "tests": "'+(16|t)+'" }',r=new Uint8Array(s.length);for(r[0]=this.MSG_EXTENDED_LOGIN,r[1]=0,r[2]=s.length-3,e=3;e<s.length;e+=1)r[e]=s.charCodeAt(e);return r},NDTjs.prototype.makeNdtMessage=function(t,e){var s,r,n;for(s='{ "msg": "'+e+'" } ',r=new Uint8Array(s.length+3),r[0]=t,r[1]=s.length>>8&255,r[2]=255&s.length,n=0;n<s.length;n+=1)r[n+3]=s.charCodeAt(n);return r},NDTjs.prototype.parseNdtMessage=function(t){var e,s=[],r=new Uint8Array(t),n=String.fromCharCode.apply(null,new Uint8Array(t.slice(3)));for(e=0;3>e;e+=1)s[e]=r[e];return s.push(n),s},NDTjs.prototype.ConnectionException=function(t){this.logger(t),this.callbacks.onerror(t)},NDTjs.prototype.UnsupportedBrowser=function(t){this.logger(t),this.callbacks.onerror(t)},NDTjs.prototype.TestFailureException=function(t){this.logger(t),this.callbacks.onerror(t)},NDTjs.prototype.createWebsocket=function(t,e,s,r,n){var o=new WebSocket(t+"://"+e+":"+s+r,n);return o.binaryType="arraybuffer",o},NDTjs.prototype.ndtC2sTest=function(){var t,e,s,r,n=new Uint8Array(this.SEND_BUFFER_SIZE),o=this,i="WAIT_FOR_TEST_PREPARE",a=0,_=o.updateInterval,T;for(r=0;r<n.length;r+=1)n[r]=32+101*r%94;return T=function(){var t=Date.now()/1e3;return e.bufferedAmount<8192&&(e.send(n),a+=n.length),o.updateInterval&&t>s+_&&(o.results.c2sRate=8*(a-e.bufferedAmount)/1e3/(t-s),o.callbacks.onprogress("interval_c2s",o.results),_+=o.updateInterval,t=Date.now()/1e3),s+10>t?void setTimeout(T,0):!1},function(r,n){return o.logger("CALLED C2S with "+r+" ("+o.NDT_MESSAGES[r]+") "+n.msg+" in state "+i),"WAIT_FOR_TEST_PREPARE"===i&&r===o.TEST_PREPARE?(o.callbacks.onstatechange("preparing_c2s",o.results),t=Number(n.msg),e=o.createWebsocket(o.serverProtocol,o.server,t,o.serverPath,"c2s"),i="WAIT_FOR_TEST_START",!1):"WAIT_FOR_TEST_START"===i&&r===o.TEST_START?(o.callbacks.onstatechange("running_c2s",o.results),s=Date.now()/1e3,T(),i="WAIT_FOR_TEST_MSG",!1):"WAIT_FOR_TEST_MSG"===i&&r===o.TEST_MSG?(o.results.c2sRate=Number(n.msg),o.logger("C2S rate calculated by server: "+o.results.c2sRate),i="WAIT_FOR_TEST_FINALIZE",!1):"WAIT_FOR_TEST_FINALIZE"===i&&r===o.TEST_FINALIZE?(o.callbacks.onstatechange("finished_c2s",o.results),i="DONE",!0):void o.logger("C2S: State = "+i+" type = "+r+"("+o.NDT_MESSAGES[r]+") message = ",n)}},NDTjs.prototype.ndtS2cTest=function(t){var e,s,r,n,o,i="WAIT_FOR_TEST_PREPARE",a=0,_=this.updateInterval,T=this;return function(c,S){if(T.logger("CALLED S2C with "+c+" ("+T.NDT_MESSAGES[c]+") in state "+i),"WAIT_FOR_TEST_PREPARE"===i&&c===T.TEST_PREPARE)return T.callbacks.onstatechange("preparing_s2c",T.results),e=Number(S.msg),s=T.createWebsocket(T.serverProtocol,T.server,e,T.serverPath,"s2c"),s.onopen=function(){T.logger("Successfully opened S2C test connection."),r=Date.now()/1e3},s.onmessage=function(t){var e,s;e=t.data.byteLength<126?2:t.data.byteLength<65536?4:10,a+=e+t.data.byteLength,s=Date.now()/1e3,T.updateInterval&&s>r+_&&(T.results.s2cRate=8*a/1e3/(s-r),T.callbacks.onprogress("interval_s2c",T.results),_+=T.updateInterval,s=Date.now()/1e3)},s.onerror=function(t){throw o=T.parseNdtMessage(t.data)[3].msg,T.TestFailureException(o)},i="WAIT_FOR_TEST_START",!1;if("WAIT_FOR_TEST_START"===i&&c===T.TEST_START)return T.callbacks.onstatechange("running_s2c",T.results),i="WAIT_FOR_FIRST_TEST_MSG",!1;if("WAIT_FOR_FIRST_TEST_MSG"===i&&c===T.TEST_MSG)return T.logger("Got message: "+JSON.stringify(S)),i="WAIT_FOR_TEST_MSG_OR_TEST_FINISH",void 0===n&&(n=Date.now()/1e3),T.results.s2cRate=8*a/1e3/(n-r),T.logger("S2C rate calculated by client: "+T.results.s2cRate),T.logger("S2C rate calculated by server: "+S.ThroughputValue),t.send(T.makeNdtMessage(T.TEST_MSG,String(T.results.s2cRate))),!1;if("WAIT_FOR_TEST_MSG_OR_TEST_FINISH"===i&&c===T.TEST_MSG){var l=S.msg.split(": "),h=l[0],p=l[1].trim();return T.results[h]=p,!1}return"WAIT_FOR_TEST_MSG_OR_TEST_FINISH"===i&&c===T.TEST_FINALIZE?(T.callbacks.onstatechange("finished_s2c",T.results),T.logger("NDT S2C test is complete: "+S.msg),!0):void T.logger("S2C: State = "+i+" type = "+c+"("+T.NDT_MESSAGES[c]+") message = ",S)}},NDTjs.prototype.ndtMetaTest=function(t){var e,s=this,r="WAIT_FOR_TEST_PREPARE";return function(n,o){if("WAIT_FOR_TEST_PREPARE"===r&&n===s.TEST_PREPARE)return s.callbacks.onstatechange("preparing_meta",s.results),r="WAIT_FOR_TEST_START",!1;if("WAIT_FOR_TEST_START"===r&&n===s.TEST_START)return s.callbacks.onstatechange("running_meta",s.results),t.send(s.makeNdtMessage(s.TEST_MSG,"client.os.name:NDTjs")),t.send(s.makeNdtMessage(s.TEST_MSG,"")),r="WAIT_FOR_TEST_FINALIZE",!1;if("WAIT_FOR_TEST_FINALIZE"===r&&n===s.TEST_FINALIZE)return s.callbacks.onstatechange("finished_meta",s.results),s.logger("NDT META test complete."),!0;throw e="Bad state and message combo for META test: "+r+", "+n+", "+o.msg,s.TestFailureException(e)}},NDTjs.prototype.startTest=function(){var t,e,s,r,n,o=[],i=this;this.checkBrowserSupport(),this.logger("Test started.  Waiting for connection to server..."),this.callbacks.onstart(this.server),t=this.createWebsocket(this.serverProtocol,this.server,this.serverPort,this.serverPath,"ndt"),t.onopen=function(){i.logger("Opened connection on port "+i.serverPort),t.send(i.makeLoginMessage(38)),s="LOGIN_SENT"},t.onmessage=function(a){var _,T=i.parseNdtMessage(a.data),c=T[0],S=JSON.parse(T[3]);if(i.logger("type = "+c+" ("+i.NDT_MESSAGES[c]+') body = "'+S.msg+'"'),void 0===e&&o.length>0&&(e=o.pop()),void 0!==e)return i.logger("Calling a subtest"),void(e(c,S)===!0&&(e=void 0,i.logger("Subtest complete")));if("LOGIN_SENT"===s)if(c===i.SRV_QUEUE){if("9990"===S.msg)t.send(i.makeNdtMessage(i.MSG_WAITING,""));else if("9977"===S.msg)throw i.TestFailureException("Server terminated test with SRV_QUEUE 9977");i.logger("Got SRV_QUEUE. Ignoring and waiting for MSG_LOGIN.")}else{if(c!==i.MSG_LOGIN)throw r="Expected type 1 (SRV_QUEUE) or 2 (MSG_LOGIN)but got "+c+" ("+i.NDT_MESSAGES[c]+")",i.TestFailureException(r);"v"!==S.msg[0]&&i.logger("Bad msg "+S.msg),s="WAIT_FOR_TEST_IDS"}else if("WAIT_FOR_TEST_IDS"===s&&c===i.MSG_LOGIN){for(_=S.msg.split(" "),n=_.length-1;n>=0;n-=1)if("2"===_[n])o.push(i.ndtC2sTest());else if("4"===_[n])o.push(i.ndtS2cTest(t));else if("32"===_[n])o.push(i.ndtMetaTest(t));else if(""!==_[n])throw r="Unknown test type: "+_[n],i.TestFailureException(r);s="WAIT_FOR_MSG_RESULTS"}else if("WAIT_FOR_MSG_RESULTS"===s&&c===i.MSG_RESULTS){i.logger(S);var l=S.msg.split("\n");for(n=0;n<l.length;n++){var h=l[n],p=h.split(": "),u=p[0],g=p[1];i.results[u]=g}}else{if("WAIT_FOR_MSG_RESULTS"!==s||c!==i.MSG_LOGOUT)throw r="No handler for message "+c+" in state "+s,i.TestFailureException(r);t.close(),i.callbacks.onstatechange("finished_all",i.results),i.callbacks.onfinish(i.results),i.logger("All tests successfully completed.")}},t.onerror=function(t){throw r=i.parseNdtMessage(t.data)[3].msg,i.TestFailureException(r)}},NDTWrapper.prototype.reset=function(){this.worker&&(this.worker.postMessage({cmd:"stop"}),this.worker=null),this.client&&(this.client=null),this._ndt_vars={ClientToServerSpeed:0,ServerToClientSpeed:0},this._errmsg="",this._status="notStarted",this._diagnosis=""},NDTWrapper.prototype.run_test=function(){var t=this;this.reset(),this.use_web_worker?(console.log("Generating new worker"),this.worker=new Worker(this.scriptPath+"/ndt-wrapper-ww-min.js"),this.worker.addEventListener("message",function(e){var s=e.data;switch(s.cmd){case"onstart":t.onstart_cb(s.server);break;case"onstatechange":t.onstatechange_cb(s.state,s.results);break;case"onprogress":t.onprogress_cb(s.state,s.results);break;case"onfinish":t.onfinish_cb(s.results);break;case"onerror":t.onerror_cb(s.error_message)}},!1),this.worker.addEventListener("error",function(e){t.onerror_cb(e.lineno," in ",e.filename,": ",e.message)},!1),this.worker.postMessage({cmd:"start",hostname:this._hostname,port:this._port,protocol:this._protocol,path:this._path,update_interval:this._update_interval})):(this.callbacks={onstart:function(e){t.onstart_cb(e)},onstatechange:function(e,s){t.onstatechange_cb(e,s)},onprogress:function(e,s){t.onprogress_cb(e,s)},onfinish:function(e){t.onfinish_cb(e)},onerror:function(e){t.onerror_cb(e)}},this.client=new NDTjs(this._hostname,this._port,this._protocol,this._path,this.callbacks,this._update_interval),this.client.startTest())},NDTWrapper.prototype.get_status=function(){return this._status},NDTWrapper.prototype.get_diagnosis=function(){return this._diagnosis},NDTWrapper.prototype.get_errmsg=function(){return this._errmsg},NDTWrapper.prototype.get_host=function(){return this._hostname},NDTWrapper.prototype.getNDTvar=function(t){return this._ndt_vars[t]},NDTWrapper.prototype.get_PcBuffSpdLimit=function(t){return Number.NaN},NDTWrapper.prototype.onstart_cb=function(t){},NDTWrapper.prototype.onstatechange_cb=function(t,e){"running_s2c"===t?(this._status="Inbound",this._ndt_vars.ServerToClientSpeed=e.s2cRate/1e3):"finished_s2c"===t?this._ndt_vars.ServerToClientSpeed=e.s2cRate/1e3:"running_c2s"===t?this._status="Outbound":"finished_c2s"==t&&(this._ndt_vars.ClientToServerSpeed=e.c2sRate/1e3)},NDTWrapper.prototype.onprogress_cb=function(t,e){"interval_s2c"==t?this._ndt_vars.ServerToClientSpeed=e.s2cRate/1e3:"interval_c2s"===t&&(this._ndt_vars.ClientToServerSpeed=e.c2sRate/1e3)},NDTWrapper.prototype.onfinish_cb=function(t){this._errmsg="Test completed",this._ndt_vars=t,this._ndt_vars.ServerToClientSpeed=t.s2cRate/1e3,this._ndt_vars.ClientToServerSpeed=t.c2sRate/1e3,this._ndt_vars.Jitter=t.MaxRTT-t.MinRTT,this.build_diagnosis()},NDTWrapper.prototype.build_diagnosis=function(){this._diagnosis=JSON.stringify(this._ndt_vars,null,"  ")},NDTWrapper.prototype.onerror_cb=function(t){this._errmsg="Test failed: "+t},NDTPlugin.prototype.check=function(){var t=!1;try{var e=new NDTjs;e.checkBrowserSupport()&&(t=!0)}catch(s){t=!1}return t},NDTPlugin.prototype.getServer=function(t,e){var s=new XMLHttpRequest;s.onreadystatechange=function(){s.readyState===XMLHttpRequest.DONE&&(200===s.status?t&&t(JSON.parse(s.responseText).fqdn):e&&e(s))},s.open("GET","https://mlab-ns.appspot.com/ndt_ssl",!0),s.send()},NDTPlugin.prototype.setServer=function(t){this.server=t},NDTPlugin.prototype.run=function(){if(this.websocket_client=new NDTWrapper(this.server,this.path),!this.websocket_client.get_status())throw"websocket client is not running properly";this.websocket_client.run_test(this.server,7123)},NDTPlugin.prototype.get_status=function(){return this.websocket_client.get_status()},NDTPlugin.prototype.get_diagnosis=function(){return this.websocket_client.get_diagnosis()},NDTPlugin.prototype.get_errmsg=function(){return this.websocket_client.get_errmsg()},NDTPlugin.prototype.get_host=function(){return this.websocket_client.get_host()},NDTPlugin.prototype.getNDTvar=function(t){return this.websocket_client.getNDTvar(t)},NDTPlugin.prototype.getStatus=function(){var t=parseFloat(this.getNDTvar("ClientToServerSpeed")),e=parseFloat(this.getNDTvar("ServerToClientSpeed")),s=parseFloat(this.getNDTvar("avgrtt")),r=parseFloat(this.getNDTvar("Jitter")),n=parseFloat(this.websocket_client.get_PcBuffSpdLimit()),o=parseFloat(this.getNDTvar("loss")),i=this.get_status(),a=this.get_errmsg();return{status:i,error:a,up:t,down:e,round:s,jitter:r,limit:n,loss:o}},NDTPlugin.prototype.getSpeedUnit=function(t){var e=["kb/s","Mb/s","Gb/s","Tb/s","Pb/s","Eb/s"],s=Math.floor(Math.log(1e3*t)/Math.log(1e3));return e[s]};