function threeD(){function e(){}function t(e,t){q=e;var a=[];e.forEach(function(e,t){var n=V([e.longitude,e.latitude]);e.x=parseInt(n[0]),e.y=-parseInt(n[1]),e.xr=e.x+Math.random(),e.yr=e.y+Math.random(),e.percentage=parseInt(e.percentage),e.z=j(e.percentage),e.name=t,e.xx=parseInt(e.xx),e.yy=parseInt(e.yy),e.social=[],e.cube=null,e.cube2=null,a[e.xx]||(a[e.xx]=[]),a[e.xx][e.yy]=e}),t.forEach(function(e){var t=a[e.x][e.y];e.x=t.x,e.y=t.y,e.z=t.z,e.xr=t.xr,e.yr=t.yr,e.instagram*=1,e.twitter*=1,e.hour*=1,t.social[e.hour]={twitter:e.twitter,instagram:e.instagram}}),e.forEach(function(e,t){var n=!1;e.social.forEach(function(e,t){(e.twitter>0||e.instagram>0)&&(n=!0)}),n&&J.push(e)}),A=d3.scale.linear().range([100,300]).domain([0,d3.max(t,function(e){return e.twitter})]),P=d3.scale.linear().range([100,300]).domain([0,d3.max(t,function(e){return e.instagram})]);var i=d3.nest().key(function(e){return e.bezirk}).entries(e),r=i.map(function(e){return p(e)}),o=d3.nest().key(function(e){return e.hour}).entries(t);D.on("click",function(){if(!d3.event.defaultPrevented){if(F.active===Y){F.active=Y=null,r.forEach(function(e){e.material.wireframe=!1,e.material.opacity=1,e.material.color.setHex(7261685),e.intersected=!1});var e=new TWEEN.Tween(H.position).to({x:0,y:0},1e3).easing(TWEEN.Easing.Quadratic.InOut).start(),t=new TWEEN.Tween({scale:C.scale()}).to({scale:1},1e3).onUpdate(function(e){C.scale(this.scale).event(D)}).easing(TWEEN.Easing.Quadratic.InOut).start()}if(Y){var n=Y.geometry.boundingBox.center().negate(),a=new TWEEN.Tween(H.position).to({x:n.x,y:n.y},1e3).easing(TWEEN.Easing.Quadratic.InOut).start(),i=new TWEEN.Tween({scale:C.scale()}).to({scale:3},1e3).onUpdate(function(e){C.scale(this.scale).event(D)}).easing(TWEEN.Easing.Quadratic.InOut).start();r.forEach(function(e){e.material.wireframe=!e.intersected,e.material.opacity=e.intersected?1:.6}),F.active=Y}}});var s=0;m(e,s),n(),c(),k=!0}function n(){E.forEach(function(e,t,n){var a=e.c,i=new THREE.SphereGeometry(10,10,10),r=new THREE.MeshBasicMaterial({color:16777215}),c=new THREE.Mesh(i,r);c.position.x=a[0],c.position.y=-a[1],c.position.z=100,c.visible=!1;var o=document.createElement("span");o.innerHTML=e.n,c.domlabel=document.createElement("div"),c.domlabel.appendChild(o),c.domlabel.style.display="none",document.getElementById("labels").appendChild(c.domlabel),H.add(c),X.push(c)})}function a(){U.setFromCamera(K,B);var e=U.intersectObjects(H.children);e.length>0?Y!==e[0].object&&e[0].object.hasOwnProperty("bezirk")&&(Y&&(Y.material.color.setHex(Y.currentHex),Y.position.z=0,Y.material.wireframe=!1,Y.intersected=!1),Y=e[0].object,Y.intersected=!0,Y.currentHex=Y.material.color.getHex(),Y.material.color.setHex(15073330),Y.material.wireframe=!1,v.style.cursor="pointer"):(Y&&(Y.material.color.setHex(Y.currentHex),Y.position.z=0,Y.material.wireframe=!1,Y.intersected=!1),Y=null,v.style.cursor="inherit")}function i(e){(F.play||screenfull.isFullscreen)&&(requestAnimationFrame(i),TWEEN.update(),c(e))}function r(){J.forEach(function(e){e.cube&&(F.instagram?e.cube.visible=!0:e.cube.visible=!1),e.cube2&&(F.twitter?e.cube2.visible=!0:e.cube2.visible=!1)})}function c(e){k&&(z.rotation.z+=.001,u(X),(F.twitter||F.instagram)&&(o(e),l()),x.render(T,B),g&&(x.domElement.toBlob(function(e){saveAs(e,"breitband.png")}),g=!1))}function o(e){var t=parseInt(e/te)%24;t!==ee&&(ee=t,s(ee))}function s(e){w.text((10>e?"0"+e:e)+":00"),J.forEach(function(t){var n=t.social[e],a=.2,i=.2,r=ae-t.z;n&&(F.instagram&&(a=r+P(n.instagram)),F.twitter&&(i=r+A(n.twitter))),t.cube&&(t.cube.animateZ=a),t.cube2&&(t.cube2.animateZ=i)})}function l(){J.forEach(function(e){e.cube&&(e.cube.position.z+=(e.z-10+e.cube.animateZ-e.cube.position.z)*ne,e.cube.scale.z=e.cube.scale.x=e.cube.scale.y+=(e.cube.animateZ/20-e.cube.scale.z)*ne),e.cube2&&(e.cube2.position.z+=(e.z-10+e.cube2.animateZ-e.cube2.position.z)*ne,e.cube2.scale.z=e.cube2.scale.x=e.cube2.scale.y+=(e.cube2.animateZ/20-e.cube2.scale.z)*ne)})}function u(e){for(var t=0;t<e.length;t++){var n=d(e[t]);e[t].domlabel.style.display="block",e[t].domlabel.style.transform="translate("+n.x+"px,"+n.y+"px)"}}function d(e){var t=(new THREE.Vector3).setFromMatrixPosition(e.matrixWorld).project(B),n=(t.x+1)/2*h,a=(-t.y+1)/2*b;return{x:n,y:a}}function m(e,t){var n=new THREE.BoxGeometry(5,5,5);n.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5));var a=new THREE.MeshLambertMaterial({color:15073330,opacity:.9,transparent:!1});window.material=a;var i=new THREE.MeshLambertMaterial({color:15073330,opacity:.9,transparent:!1}),c=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.8,fog:!1});e.forEach(function(e){var t;e.social.filter(function(e){return 0!==e.instagram}).length>0&&(t=new THREE.Mesh(n,a),t.position.x=e.x,t.position.y=e.y,t.position.z=e.z,t.visible=!0,e.cube=t,H.add(t)),e.social.filter(function(e){return 0!==e.twitter}).length>0&&(t=new THREE.Mesh(n,i),t.position.x=e.x+10,t.position.y=e.y,t.position.z=e.z,t.visible=!0,e.cube2=t,H.add(t))}),r()}function p(e){var t=e.values,n=Q.triangles(t),a=new THREE.Geometry;a.vertices=t.map(function(e,t){return e.id=t,new THREE.Vector3(e.x,e.y,e.z)}),n.forEach(function(e){var t=(Math.abs(e[0].x-e[1].x)+Math.abs(e[1].x-e[2].x)+Math.abs(e[0].x-e[2].x))/3,n=(Math.abs(e[0].y-e[1].y)+Math.abs(e[1].y-e[2].y)+Math.abs(e[0].y-e[2].y))/3;t>20||n>20||a.faces.push(new THREE.Face3(e[0].id,e[1].id,e[2].id))}),a.computeFaceNormals(),a.computeBoundingBox();var i=new THREE.MeshLambertMaterial({color:7261685,side:THREE.BackSide,wireframe:!1,transparent:!0}),r=new THREE.Mesh(a,i);return r.bezirk=e.key,H.add(r),r}function f(e){for(var t=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],a=new ArrayBuffer(t.length),i=new Uint8Array(a),r=0;r<t.length;r++)i[r]=t.charCodeAt(r);var c=new DataView(a),o=new Blob([c],{type:n});return o}var E=[{c:[-164.94678225444946,-63.029871437100326],n:"Mitte"},{c:[52.778130057326905,103.42041724165729],n:"Friedrichshain-Kreuzberg"},{c:[94.44270055577594,-432.5721103772772],n:"Pankow"},{c:[-499.09505521863184,119.66473570559107],n:"Charlottenburg-Wilmersdorf"},{c:[-818.1448708597577,-22.566868616095963],n:"Spandau"},{c:[-607.8190923800062,498.97261500635307],n:"Steglitz-Zehlendorf"},{c:[-113.29687363849465,462.53109998602974],n:"Tempelhof-Schöneberg"},{c:[145.7122760209756,463.22536731944496],n:"Neukölln"},{c:[691.0693806464119,528.9735270041073],n:"Treptow-Köpenick"},{c:[578.0995751704685,4.466256221793847],n:"Marzahn-Hellersdorf"},{c:[337.0342485538481,-74.80341059918459],n:"Lichtenberg"},{c:[-425.4280684254382,-423.6349448086686],n:"Reinickendorf"}];d3.select(".company-help").on("click",function(){d3.select(".company-help").style("display","none")}),d3.select(".infobtn").on("click",function(){d3.select(".company-help").style("display","block")}),d3.select(".instagram").on("click",function(t){F.instagram=!F.instagram,F.twitter&&(F.twitter=!1),d3.select(".twitter").classed("active",!1),d3.select(this).classed("active",F.instagram),e.updateSocialStatus()}),d3.select(".twitter").on("click",function(t){F.twitter=!F.twitter,F.instagram&&(F.instagram=!1),d3.select(".instagram").classed("active",!1),d3.select(this).classed("active",F.twitter),e.updateSocialStatus()}),d3.select(".menu .screenshot").on("click",function(e){g=!0}),e.updateSocialStatus=function(){F.twitter||F.instagram?d3.select(".time").style("display","block"):d3.select(".time").style("display","none"),r()},e.resize=function(){var e=d3.select("#container").node().getBoundingClientRect();h=e.width,b=e.height,B.aspect=h/b,B.updateProjectionMatrix(),x.setSize(h,b)},e.play=function(){F.play||(F.play=!0,i())},e.pause=function(){F.play=!1},d3.select(".fullscreen").on("click",function(t){screenfull.toggle(),e.play(),d3.select(this).classed("active",screenfull.isFullscreen)}).style("display",function(){return screenfull.enabled});var y=d3.select("#container").node().getBoundingClientRect(),h=y.width,b=y.height,g=!1,w=d3.select(".time .clock"),v=document.getElementById("container"),x=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!1});x.setClearColor(1980305),x.setSize(h,b),v.appendChild(x.domElement);var T=new THREE.Scene,z=new THREE.Scene,H=new THREE.Scene;T.add(z),z.add(H);var R=new Date,M=new Date;M.setDate(R.getDate()-1),d3.select(".date").text((M.getDate()<10?"0":"")+M.getDate()+"."+(M.getMonth()<10?"0":"")+M.getMonth()+"."+M.getFullYear()),T.add(new THREE.HemisphereLight(16777215,1980305));var k=!1,S=new THREE.DirectionalLight(16777215,1);S.position.set(1,100,300),T.add(S);var B=new THREE.PerspectiveCamera(50,h/b,1,1e4);B.position.x=0,B.position.y=-1800,B.position.z=1100,B.lookAt(T.position);var I=d3.behavior.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}).on("drag",function(e){z.rotation.z+=d3.event.dx/100}),W=(new THREE.Vector3).copy(B.position),C=d3.behavior.zoom().scaleExtent([1,5]).on("zoom",function(e){B.position.y=W.y/d3.event.scale,B.position.z=W.z/d3.event.scale,B.lookAt(T.position)}),N=C.scale(),D=d3.select(x.domElement).datum({drag:!1}).call(I).call(C).on("mousemove",function(){var e=d3.mouse(this);K.x=e[0]/h*2-1,K.y=2*-(e[1]/b)+1,F.active||a()}),F={fullscreen:!1,play:!1,active:null,twitter:!1,instagram:!1},L=d3.time.format("%Y-%m-%d").parse,j=d3.scale.linear().range([1,50]).domain([0,5]),A,P,Z=d3.scale.log().range([1,200]).domain([1,50]),O=[13.413215,52.521918],V=d3.geo.mercator().scale(24e4).center(O).translate([0,0]),G=d3.geo.path().projection(V),Q=d3.geom.voronoi().x(function(e){return e.xr}).y(function(e){return e.yr}),U=new THREE.Raycaster,K=new THREE.Vector2,Y,q,J=[];d3.csv("data/50mbit.csv",function(e,n){d3.csv("http://tsb.sebastianmeier.eu/static/data.csv",function(e,a){t(n,a)})});var X=[],_=0,ee=0,te=400,ne=.05,ae=60;try{window.self!==window.top||(F.play=!0,i())}catch(ie){}return e}