function d3_compare(){function e(i){t=i,d3.csv("data/all.csv").get(function(t,i){i.forEach(function(e){e.jahr*=1,e.leitung50*=1,e.leitung16*=1}),n=["leitung16","leitung50"].map(function(e){return i.map(function(t){return{type:e,value:t[e],ortsteil:t.ortsteil,bezirk:t.bezirk,jahr:t.jahr,data:t}})}).reduce(function(e,t){return e.concat(t)},[]),a=d3.nest().key(function(e){return e.type}).key(function(e){return e.bezirk}).key(function(e){return e.jahr}).rollup(function(e){var t=d3.mean(e,function(e){return e.value});return e.forEach(function(e){e.mean=t}),t}).entries(n),a.forEach(function(e,t,n){e.values.forEach(function(t,n,r){M[e.key][t.key]=t.values[2].values})}),l=d3.nest().key(function(e){return e.type}).key(function(e){return e.bezirk}).key(function(e){return e.ortsteil}).entries(n),r=d3.nest().key(function(e){return e.bezirk}).entries(n),r.forEach(function(e){e.mean=parseInt(d3.mean(e.values.filter(function(e){return 2015===e.jahr}),function(e){return e.value}))}),r.sort(function(e,t){return t.mean-e.mean}),e.init()})}var t,n,r,l,a,i,c,o,s,u,d,f,v,p,k,h,y,m,g,b={activeMenu:!1,item:null},A={leitung16:"> 16Mbit",leitung50:"> 50Mbit"},z=[0,25,50,70,85,95,100],x={top:20,right:45,bottom:20,left:45},M={leitung16:{},leitung50:{}},j={Wilmersdorf:"Charlottenburg-Wilmersdorf",Kreuzberg:"Friedrichshain-Kreuzberg",Wartenberg:"Lichtenberg",Hellersdorf:"Marzahn-Hellersdorf",Rudow:"Neukölln",Wilhelmsruh:"Pankow",Hansaviertel:"Mitte",Wittenau:"Reinickendorf",Wilhelmsstadt:"Spandau",Tempelhof:"Tempelhof-Schöneberg",Zehlendorf:"Steglitz-Zehlendorf","Schmöckwitz":"Treptow-Köpenick"};return e.resize=function(){m.selectAll("*").remove();var t=d3.select("#compare .chart .col"),n=t.node().getBoundingClientRect();i=n.width-x.right-x.left,c=n.height-x.top-x.bottom,o=d3.scale.linear().range([0,i]).domain([2011,2015]),u=c/(z.length-1),d=[6*u,5*u,4*u,3*u,2*u,u,0],s=d3.scale.linear().range(d).domain(z),f=d3.svg.axis().scale(o).orient("bottom").tickValues([2011,2012,2013,2015]).tickFormat(d3.format("")),v=d3.svg.axis().tickFormat(function(e){return e>0?e+"%":void 0}).scale(s).orient("left").tickSize(-i),p=d3.svg.line().x(function(e){return o(e.jahr)}).y(function(e){return s(e.mean)}),k=d3.svg.line().x(function(e){return o(e.jahr)}).y(function(e){return s(e.value)}),m.call(e.makeAxis);var r=m.selectAll(".bezirke").data(function(e){return e.values}).enter().append("g").attr("class","real").attr("data-key",function(e){return d3.select(this.parentNode).data()[0].key}).classed("bezirke",!0),l=m.selectAll(".bezirke.alpha").data(function(e){return e.values}).enter().append("g").attr("class","alpha").attr("data-key",function(e){return d3.select(this.parentNode).data()[0].key}).classed("bezirke",!0);[r,l].forEach(function(e,t,n){e.selectAll(".ortsteil").data(function(e){return e.values}).enter().append("path").attr("id",function(e){return"ortsteil_"+e.key}).attr("class",function(e){return j[e.key]in M.leitung50?"overbezirk":"normalbezirk"}).classed("ortsteil",!0).attr("d",function(e){return p(e.values)}).on("mouseenter",function(e){var t=d3.select(this.parentNode).datum(),n=d3.select(this.parentNode).attr("data-key"),r=$("#"+n).offset(),l=r.left+o(e.values[2].jahr)+x.left,a;a=b.activeMenu?r.top+s(e.values[2].value)+x.top+3:r.top+s(e.values[2].mean)+x.top+3,h.selectAll(".entry").classed("hover",function(e){return e.key===t.key&&!b.activeMenu}),y.classed("hover",!0).selectAll(".bezirke").classed("active",function(e){return t.key===e.key}).filter(".active").moveToFront(),y.selectAll(".bezirke").selectAll(".ortsteil").classed("hover",function(t){return e.key===t.key}).filter(".hover").moveToFront();var i=b.activeMenu?e.key:t.key;tooltip.content('<strong class="center">'+i+"</strong>"),tooltip.position([l,a]),tooltip.show()}).on("mouseleave",function(e){h.selectAll(".entry").classed("hover",!1),y.classed("hover",!1).selectAll(".bezirke").classed("hover",!1).selectAll(".ortsteil").classed("hover",!1),tooltip.hide()}).on("click",function(e){var t=d3.select(this.parentNode).datum(),n=h.selectAll(".entry").filter(function(e){return t.key===e.key}).node().click()})})},e.init=function(){h=d3.select("#compare-legend").append("div").classed("menu",!0),y=d3.select("#compare .chart"),h.on("mouseout",function(e){b.activeMenu||y.classed("active",!1).selectAll(".bezirke").classed("active",!1)}),g=h.selectAll("div").data(r).enter().append("div").classed("entry",!0).on("click",function(e){h.selectAll(".entry").classed("hover",!1),b.item===e.key&&b.activeMenu?(b.activeMenu=!1,y.selectAll(".bezirke").selectAll(".ortsteil").transition().attr("d",function(e){return p(e.values)}).each("end",function(e,t){0===t&&y.classed("expand",!1).classed("active",!1)})):(b.activeMenu=!0,y.classed("expand",!0).classed("active",!0),y.selectAll(".bezirke").selectAll(".ortsteil").transition().attr("d",function(e){return p(e.values)}),y.selectAll(".bezirke").classed("active",function(t){return e.key===t.key}).filter(".active").moveToFront().selectAll(".ortsteil").transition().attr("d",function(e){return k(e.values)})),b.item=e.key,h.selectAll(".entry").classed("active",function(t){return e.key===t.key&&b.activeMenu}),tooltip.hide()}).on("mouseenter",function(e){b.activeMenu||(h.selectAll(".entry").classed("hover",function(t){return t.key===e.key}),y.classed("active",!0).selectAll(".bezirke").classed("active",function(t){return e.key===t.key}).filter(".active").moveToFront())}),g.append("div").text("×").classed("close",!0),g.append("div").text(function(e){return e.mean+"%"}).classed("labell",!0),g.append("div").classed("labell",!0).text(function(e,t){return e.key});var t=y.selectAll("div").data(l).enter().append("div").each(function(e){return e}).attr("class","col col-xs-12 col-sm-4 col-lg-4").append("svg").attr("id",function(e){return e.key}).append("g").attr("transform","translate("+x.left+","+x.top+")");t.append("text").text(function(e){return A[e.key]}).attr("y",-10),m=t.append("g"),e.resize()},e.makeAxis=function(e){var t=e.append("g");t.append("g").attr("class","x axis").attr("transform","translate(0,"+c+")").call(f);var n=t.append("g").attr("class","y axis").call(v);n.selectAll("text").attr("x",-6),n.selectAll("g").filter(function(e){return e}).classed("minor",!0)},e}d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};