function speedTest(){function t(){}var e={indicator:{},graph:{}},a=["upload","download"],r={upload:6,download:30},n={upload:0,download:0},d={upload:0,download:0},s={upload:0,download:0},o={upload:!1,download:!1},i={upload:"up",download:"down"},l={upload:{x:null,y:null},download:{x:null,y:null}},p={width:150,height:150,radius:70},c={height:150,width:480},u=!1,h=110,g=400,f={},y=d3.svg.arc().innerRadius(p.radius-2).outerRadius(p.radius+2),x=!1,w,m,v=49,A,M={upload:{x:d3.scale.linear().range([0,g]).domain([0,r.upload]),y:d3.scale.linear().range([0,h]).domain([100,0]),area:d3.svg.area().x(function(t){return M.upload.x(t[1]/v*r.upload)}).y1(function(t){return M.upload.y(t[0]/s.upload*100)}).y0(h)},download:{x:d3.scale.linear().range([0,g]).domain([0,r.download]),y:d3.scale.linear().range([0,h]).domain([100,0]),area:d3.svg.area().x(function(t){return M.download.x(t[1]/v*r.download)}).y1(function(t){return M.download.y(t[0]/s.download*100)}).y0(h)}};return t.init=function(){a.forEach(function(t,a){e.indicator[t]=d3.select("#"+t+"_indicator").append("svg").attr("height",p.height).attr("width",p.width).attr("viewBox","0 0 "+p.width+" "+p.height).attr("preserveAspectRatio","xMinYMin meet").append("g").attr("transform","translate("+p.width/2+","+p.height/2+")"),e.indicator[t].append("g").append("circle").attr("class","bg").attr("r",p.radius),e.indicator[t].append("text").style("opacity",.5).attr("dy",15).attr("text-anchor","middle").attr("id","spdtst_"+t).attr("class","speed_live").text("0.00"),e.indicator[t].append("text").style("opacity",.5).text(t).attr("text-anchor","middle").attr("dy",35).attr("class","speed_type"),e.indicator[t].append("text").style("opacity",.5).text("Mbit/s").attr("text-anchor","middle").attr("dy",-25).attr("class","speed_speed"),e.indicator[t].append("path").attr("transform","rotate("+d[t]+")").attr("id",t+"_progress").datum({newEndAngle:Math.PI/4,newStartAngle:0,startAngle:0,endAngle:Math.PI/4,opacity:0,type:t}).attr("d",y).attr("class","progress").style("opacity",0),e.graph[t]=d3.select("#"+t+"_graph").append("svg").attr("height",c.height).attr("width",c.width).attr("viewBox","0 0 "+c.width+" "+c.height).attr("preserveAspectRatio","xMinYMin meet").append("g").attr("transform","translate("+(c.width-g)/2+","+(c.height-h)/2+")");var n=[25,50,75,100];e.graph[t].append("g").selectAll("line").data(n).enter().append("line").attr("class","bglines").attr("x1",0).attr("x2",g).attr("y1",M[t].y).attr("y2",M[t].y),l[t].x=d3.svg.axis().orient("bottom").scale(M[t].x).ticks(7).tickFormat(function(e){return e+(e===r[t]?" Mbit/s":"")}),e.graph[t].append("g").attr("class","axis x-axis").attr("transform","translate(0,"+h+")").call(l[t].x),l[t].y=d3.svg.axis().orient("left").scale(M[t].y).tickValues([0,25,50,75,100]),e.graph[t].append("g").attr("class","axis y-axis").attr("transform","translate(0,0)").call(l[t].y)}),t.animate(),d3.json("./data/data.json",function(n,d){n&&console.log(n),A=d,a.forEach(function(t,a){s[t]=d3.max(A[t],function(t){return t[0]}),e.graph[t].append("g").append("path").datum(A[t]).attr("class","trend").attr("d",M[t].area),A[t].forEach(function(e,a){e[0]<A[t][0][0]/2&&!o[t]&&(o[t]=a)});var n=A[t][o[t]][0],d=A[t][o[t]-1][0],i=(A[t][0][0]/2-n)/(d-n);o[t]=A[t][o[t]][1]+i*(A[t][o[t]-1][1]-A[t][o[t]][1]),e.graph[t].append("g").attr("transform","translate("+M[t].x(o[t]/v*r[t])+","+M[t].y(50)+")").append("circle").attr("r",3).attr("class","avg"),e.graph[t].append("g").append("path").attr("class","avg").attr("d","M"+M[t].x(o[t]/v*r[t])+","+h+"L"+M[t].x(o[t]/v*r[t])+","+M[t].y(50)+"L"+M[t].x(r[t]/2)+","+M[t].y(62.5)+"L"+(M[t].x(r[t])-("upload"===t?0:57))+","+M[t].y(62.5));var l=e.graph[t].append("g").append("line").attr("class","coverup").attr("y1",h/4).attr("y2",h/4).attr("x1",g/2-5);"upload"===t?l.attr("x2",g):l.attr("x2",g-57);var p=e.graph[t].append("g").attr("transform","translate("+M[t].x(r[t]/2)+","+("upload"===t?5:20)+")").append("text");"upload"===t&&p.append("tspan").attr("x",0).attr("dy","1.25em").text("Durchschnitt Berliner Speed-Test"),p.append("tspan").attr("x",0).attr("dy","1.25em").text(("upload"===t?"Nutzer*innen: ":"")+(o[t]/v*r[t]).toFixed(2)+" Mbit/s "+t.charAt(0).toUpperCase()+t.slice(1))}),d3.select("#spdtst-start").on("click",function(){x||(x=!0,d3.select("#spdtst-start").text("Test läuft...").classed("active",!0),d3.selectAll(".speed_live,.speed_speed,.speed_type,path").style("opacity",1),d3.selectAll("circle.userspeed").remove(),d3.selectAll("#spdtst path.progress").datum(function(t){return t.opacity=1,t.newEndAngle=Math.PI/4,t.endAngle=Math.PI/4,t}),t.animate(),d3.selectAll("#spdtst .speed_live").text("0.00"),w=new NDTPlugin("./js"),w.check()?w.getServer(function(e){w.setServer(e),w.run(),m=setInterval(t.reportStatus,100)},function(t){t&&(alert("Leider konnte der Test nicht erfolgreich durchgeführt werden. Dies kann möglicherweise an einer Firewall oder ähnlichen Sicherheitsvorkehrungen liegen."),d3.selectAll("#spdtst path.progress").datum(function(t){return t.opacity=0,t.newEndAngle=2*Math.PI,t})),console.log("error",t)}):(d3.select("#spdtst-start").remove(),u||(d3.select("#spdtst>.container>.row>.col").append("p").attr("class","spd-note").text("Leider unterstütz Ihr Browser nicht die Mindestanforderungen."),u=!0),d3.selectAll("#spdtst path.progress").datum(function(t){return t.opacity=0,t.newEndAngle=2*Math.PI,t}),console.log("sorry your browser does not support this")))})})},t.speed2pop=function(t,e){var a=!1;A[e].forEach(function(n,d){r[e]/v*d>t&&!a&&(a=d)});var n=A[e][a][1]/v*r[e],d=A[e][a-1][1]/v*r[e],s=(t-n)/(d-n);return a=(A[e][a][0]+s*(A[e][a-1][0]-A[e][a][0]))/A[e][0][0]*100},t.animate=function(){a.forEach(function(e,a){d3.select("#"+e+"_progress").transition().duration(2e3).attrTween("transform",t.rotTween()).style("opacity",function(t){return t.opacity}).attrTween("d",t.arcTween()).each("end",function(e){"upload"===e.type&&x&&t.animate()})})},t.rotTween=function(){return function(t){var e=d3.interpolate(0,360);return function(t){return"rotate("+e(t)+")"}}},t.reportStatus=function(){var r=w.getStatus();r.error.indexOf("Test failed")>=0?(d3.select("#spdtst-start").remove(),u||(d3.select("#spdtst>.container>.row>.col").append("p").attr("class","spd-note").text("Leider unterstütz Ihr Browser nicht die Mindestanforderungen oder eine Firewall verhindert das Durchführen des Tests."),u=!0),d3.selectAll("#spdtst path.progress").datum(function(t){return t.opacity=0,t.newEndAngle=2*Math.PI,t}),clearInterval(m)):(a.forEach(function(a){var d=parseFloat(r[i[a]]);("NaN"===d||isNaN(d))&&(d=0),n[a]=d;var s=10>d?d.toFixed(2):d>99?Math.round(d):d.toFixed(1);e.indicator[a].select(".speed_live").text(s),d>0&&(d3.select("#"+a+"_progress").datum(function(t){return t.newEndAngle+=Math.PI/100,t}),"download"===a&&d3.select("#upload_progress").datum(function(e){return e.newEndAngle=2*Math.PI,e.opacity>0&&t.setPoint("upload"),e.opacity=0,e}))}),r.error.match(/completed/)&&(clearInterval(m),d3.select("#download_progress").datum(function(t){return t.newEndAngle=2*Math.PI,t.opacity=0,t}),setTimeout(function(){x=!1,t.setPoint("download"),d3.select("#spdtst-start").html('<span class="image image-speed"></span>Erneut testen!').classed("active",!1)},2e3)))},t.setPoint=function(a){if(n[a]<r[a])for(var d=t.speed2pop(n[a],a),s=0;2>s;s++){var o=e.graph[a].append("circle").attr("r",5).attr("cx",M[a].x(n[a])).attr("cy",M[a].y(d)).attr("class","userspeed"+(0===s?" ani":""));0===s&&o.transition().duration(500).style("opacity",0).attr("r",20)}},t.arcTween=function(){return function(t){var e=d3.interpolate(t.startAngle,t.newStartAngle),a=d3.interpolate(t.endAngle,t.newEndAngle);return function(r){return t.endAngle=a(r),t.startAngle=e(r),y(t)}}},t}